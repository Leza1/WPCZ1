# ğŸš€ WPCZ1 - Water Pump Controller Zigbee 1
WPCZ1 lÃ  báº£n mod chuyá»ƒn Ä‘á»•i cÃ¡c cÃ´ng táº¯c Zigbee cÃ³ sáºµn trÃªn thá»‹ trÆ°á»ng thÃ nh bá»™ Ä‘iá»u khiá»ƒn bÆ¡m nÆ°á»›c (sá»­ dá»¥ng phao Ä‘iá»‡n) trong cÃ¡c há»™ gia Ä‘Ã¬nh táº¡i Viá»‡t Nam.

<div align="center">
  <img src="doc/images/wpcz1.svg" alt="wpcz1" width="400"/>
</div>

PhiÃªn báº£n Ä‘áº§u tiÃªn nÃ y há»— trá»£ cÃ¡c cÃ´ng táº¯c Xiaomi Aqara QBKG11LM (cÃ´ng táº¯c Ä‘Æ¡n) vÃ  QBKG12LM (cÃ´ng táº¯c Ä‘Ã´i), cÃ³ ná»‘i dÃ¢y trung tÃ­nh.

## âœ¨ TÃ­nh nÄƒng
- Äiá»u khiá»ƒn bÆ¡m nÆ°á»›c báº±ng phao Ä‘iá»‡n nhÆ° truyá»n thá»‘ng, Ä‘á»“ng thá»i bá»• sung kháº£ nÄƒng báº­t / táº¯t bÆ¡m thá»§ cÃ´ng thÃ´ng qua nÃºt nháº¥n trÃªn bá»™ Ä‘iá»u khiá»ƒn.
- Há»— trá»£ Ä‘iá»u khiá»ƒn tá»« xa thÃ´ng qua cÃ¡c á»©ng dá»¥ng nhÃ  thÃ´ng minh.
- Hiá»ƒn thá»‹ cÃ¡c thÃ´ng sá»‘ nhÆ° cÃ´ng suáº¥t, Ä‘iá»‡n Ã¡p, dÃ²ng Ä‘iá»‡n, sá»‘ láº§n báº­t / táº¯t,... giÃºp dá»… dÃ ng giÃ¡m sÃ¡t hoáº¡t Ä‘á»™ng cá»§a bÆ¡m vÃ  phÃ¡t hiá»‡n cÃ¡c báº¥t thÆ°á»ng (quÃ¡ táº£i, quÃ¡ nhiá»‡t, rÃ² rá»‰ nÆ°á»›c gÃ¢y báº­t / táº¯t liÃªn tá»¥c,...).
- TÃ­ch há»£p chá»©c nÄƒng báº£o vá»‡ quÃ¡ nhiá»‡t (trÃªn 55Â°C) vÃ  quÃ¡ táº£i (trÃªn 2000W).
- Äiá»u khiá»ƒn Ä‘Ã³ng / ngáº¯t bÆ¡m táº¡i Ä‘iá»ƒm Ä‘iá»‡n Ã¡p xáº¥p xá»‰ 0V nháº±m giáº£m hiá»‡n tÆ°á»£ng tia lá»­a Ä‘iá»‡n, giÃºp tÄƒng tuá»•i thá» cho rÆ¡ le.

## ğŸ“¸ áº¢nh chá»¥p mÃ n hÃ¬nh
![Screenshot](doc/images/screenshot1.png)

## âš™ï¸ HÆ°á»›ng dáº«n
### ğŸ›  Thay Ä‘á»•i pháº§n cá»©ng
âš ï¸ **Cáº£nh bÃ¡o an toÃ n**
- âš ï¸ Pháº§n thao tÃ¡c nÃ y **chá»‰ nÃªn Ä‘Æ°á»£c thá»±c hiá»‡n bá»Ÿi ngÆ°á»i cÃ³ chuyÃªn mÃ´n vá» Ä‘iá»‡n - Ä‘iá»‡n tá»­**. Viá»‡c láº¯p Ä‘áº·t hoáº·c sá»­a Ä‘á»•i sai cÃ¡ch cÃ³ thá»ƒ gÃ¢y **nguy hiá»ƒm Ä‘áº¿n tÃ­nh máº¡ng**, cÅ©ng nhÆ° **gÃ¢y chÃ¡y ná»• thiáº¿t bá»‹.**
- âš ï¸ **KhÃ´ng nÃªn tá»± thá»±c hiá»‡n náº¿u báº¡n khÃ´ng cÃ³ chuyÃªn mÃ´n** - hÃ£y **nhá» ká»¹ thuáº­t viÃªn chuyÃªn nghiá»‡p** hoáº·c **sá»­ dá»¥ng thiáº¿t bá»‹ Ä‘Ã£ Ä‘Æ°á»£c mod sáºµn** Ä‘á»ƒ Ä‘áº£m báº£o an toÃ n.

Xiaomi Aqara QBKG11LM vÃ  QBKG12LM dÃ¹ng chung PCB (mÃ£ LM15-LNS-PA-A-T0), chá»‰ khÃ¡c nhau sá»‘ lÆ°á»£ng nÃºt nháº¥n vÃ  sá»‘ rá» le bÃªn trong.
- QBKG11LM: CÃ³ má»™t nÃºt nháº¥n Ä‘iá»u khiá»ƒn má»™t rÆ¡ le ngÃµ ra.
- QBKG12LM: ÄÆ°á»£c hÃ n thÃªm linh kiá»‡n Ä‘á»ƒ má»Ÿ rá»™ng thÃ nh hai nÃºt nháº¥n, Ä‘iá»u khiá»ƒn hai rÆ¡ le ngÃµ ra.

âœ³ï¸ WPCZ1 sá»­ dá»¥ng **nÃºt nháº¥n bÃªn trÃ¡i** Ä‘á»ƒ káº¿t ná»‘i vá»›i **phao Ä‘iá»‡n**, vÃ  **nÃºt nháº¥n bÃªn pháº£i** Ä‘á»ƒ **báº­t / táº¯t bÆ¡m thá»§ cÃ´ng táº¡i chá»—**.
- QBKG11LM:
  - Cáº§n **hÃ n thÃªm Ä‘iá»‡n trá»Ÿ R2 4K7 (SMD 0402)** vÃ  **tá»¥ Ä‘iá»‡n C2 100nF (SMD 0402).**
  - HÃ n **dÃ¢y káº¿t ná»‘i phao Ä‘iá»‡n** vÃ o **nÃºt nháº¥n S1 bÃªn trÃ¡i.**
  - Xem [hÃ¬nh áº£nh chi tiáº¿t](doc/QBKG11LM_modify.md)
  ![QBKG11LM](doc/images/QBKG11LM_modify.png)
- QBKG12LM:
  - **ThÃ¡o bá» nÃºt nháº¥n bÃªn trÃ¡i** Ä‘á»ƒ dÃ¹ng cho phao Ä‘iá»‡n.
  - NÃªn **thay Ä‘iá»‡n trá»Ÿ cÃ³ sáºµn R2 100K (SMD 0402)** báº±ng **4K7 (SMD 0402)** nháº±m tÄƒng Ä‘á»™ nháº¡y cho phao Ä‘iá»‡n Ä‘áº·t xa.
  - HÃ n **dÃ¢y káº¿t ná»‘i phao Ä‘iá»‡n** vÃ o **nÃºt nháº¥n S1 bÃªn trÃ¡i.**

### ğŸ”Œ Äáº¥u ná»‘i dÃ¢y Ä‘iá»‡n
![Wiring Connection](doc/images/Wiring-connection.png)

### ğŸ§© TÃ­ch há»£p vá»›i Zigbee2MQTT
Khi vá»«a tham gia máº¡ng, Zigbee2MQTT sáº½ liá»‡t kÃª **WPCZ1** lÃ  **thiáº¿t bá»‹ chÆ°a Ä‘Æ°á»£c há»— trá»£**, vÃ  **khÃ´ng hiá»ƒn thá»‹ báº¥t ká»³ tÃ­nh nÄƒng nÃ o.**

Äá»ƒ tÃ­ch há»£p WPCZ1 vÃ o Zigbee2MQTT, thá»±c hiá»‡n theo cÃ¡c bÆ°á»›c sau:
- Sao chÃ©p file [wpcz1.js](z2m/wpcz1.js) vÃ o thÆ° má»¥c: `zigbee2mqtt/data/external_converters`
- ThÃªm cáº¥u hÃ¬nh sau vÃ o tá»‡p `configuration.yaml`:
```yaml
external_converters:
  - wpcz1.js
```
- Sau khi khá»Ÿi Ä‘á»™ng láº¡i Zigbee2MQTT, **cÃ¡c tÃ­nh nÄƒng cá»§a WPCZ1 sáº½ Ä‘Æ°á»£c hiá»ƒn thá»‹ vÃ  há»— trá»£ Ä‘áº§y Ä‘á»§.**

### ğŸ“¦ Cáº­p nháº­t firmware (OTA)
Firmware `WPCZ1.ota` há»— trá»£ cáº­p nháº­t qua OTA (Over-The-Air). CÃ³ thá»ƒ dÃ¹ng Zigbee2MQTT theo cÃ¡c bÆ°á»›c sau:
- **Táº£i firmware** [WPCZ1.ota](ota/WPCZ1.ota) vÃ o thÆ° má»¥c: `zigbee2mqtt/data` (cÃ¹ng cáº¥p vá»›i file `configuration.yaml`).
- **Khai bÃ¡o OTA** báº±ng cÃ¡ch táº¡o hoáº·c sao chÃ©p / ghi Ä‘Ã¨ file [my_index.json](z2m/my_index.json) vÃ o thÆ° má»¥c: `zigbee2mqtt/data` vá»›i ná»™i dung sau (cho QBKG11LM):
```json
[
    {
        "modelId": "lumi.ctrl_ln1.aq1",
        "url": "WPCZ1.ota",
        "force": true
    }
]
```
- Khai bÃ¡o Ä‘Æ°á»ng dáº«n tá»›i file `my_index.json` trong `configuration.yaml`:
```yaml
ota:
  zigbee_ota_override_index_location: my_index.json
```
- Thiáº¿t bá»‹ sáº½ xuáº¥t hiá»‡n trong trang OTA cá»§a Zigbee2MQTT
  - Nháº¥p vÃ o **"Check firmware update"** Ä‘á»ƒ kiá»ƒm tra báº£n cáº­p nháº­t kháº£ dá»¥ng.
  - Nháº¥n **"Update firmware"** Ä‘á»ƒ báº¯t Ä‘áº§u cáº­p nháº­t.
- HoÃ n táº¥t cáº­p nháº­t
  - **XÃ³a thiáº¿t bá»‹** QBKG11LM (hoáº·c QBKG12LM) cÅ© khá»i Zigbee2MQTT (nhá»› chá»n **"Force remove"**).
  - **Khá»Ÿi Ä‘á»™ng láº¡i Zigbee2MQTT**, Ä‘áº·t cháº¿ Ä‘á»™ **"Permit join (All)".**
  - Khá»Ÿi Ä‘á»™ng láº¡i WPCZ1, **thiáº¿t bá»‹ sáº½ tá»± Ä‘á»™ng tham gia máº¡ng Zigbee** vÃ  hoáº¡t Ä‘á»™ng vá»›i **cÃ¡c tÃ­nh nÄƒng má»›i** Ä‘Ã£ Ä‘Æ°á»£c cáº­p nháº­t.

Xem [hÃ¬nh áº£nh chi tiáº¿t](doc/QBKG11LM_Z2M.md)

**LÆ°u Ã½:**
- Thá»i gian cáº­p nháº­t cÃ³ thá»ƒ máº¥t **10 â€“ 20 phÃºt**.
- **Äáº·t thiáº¿t bá»‹ gáº§n hub Zigbee** vÃ  Ä‘áº£m báº£o **máº¡ng á»•n Ä‘á»‹nh** trong suá»‘t quÃ¡ trÃ¬nh cáº­p nháº­t.

### ğŸ“– CÃ¡ch sá»­ dá»¥ng WPCZ1
- **Äiá»u khiá»ƒn bÆ¡m nÆ°á»›c tá»± Ä‘á»™ng:** BÆ¡m sáº½ **tá»± Ä‘á»™ng báº­t khi phao Ä‘iá»‡n kÃ­ch hoáº¡t** (má»±c nÆ°á»›c tháº¥p) vÃ  **tá»± Ä‘á»™ng táº¯t khi phao ngá»«ng kÃ­ch hoáº¡t** (má»±c nÆ°á»›c cao).
- **Äiá»u khiá»ƒn bÆ¡m thá»§ cÃ´ng:** Nháº¥n nÃºt trÃªn cÃ´ng táº¯c QBKG11LM (hoáº·c nÃºt pháº£i cá»§a QBKG12LM) Ä‘á»ƒ báº­t / táº¯t bÆ¡m thá»§ cÃ´ng.
- Khi má»›i cáº­p nháº­t firmware `WPCZ1.ota` cho QBKG11LM (hoáº·c QBKG12LM), thiáº¿t bá»‹ sáº½ **tá»± Ä‘á»™ng dÃ² tÃ¬m vÃ  tham gia máº¡ng Zigbee**. Náº¿u cáº§n káº¿t ná»‘i thá»§ cÃ´ng, thá»±c hiá»‡n nhÆ° sau:
  - **ChÆ°a káº¿t ná»‘i máº¡ng:** Nháº¥n giá»¯ nÃºt trÃªn cÃ´ng táº¯c QBKG11LM (hoáº·c nÃºt pháº£i cá»§a QBKG12LM) **hÆ¡n 8 giÃ¢y** Ä‘á»ƒ báº¯t Ä‘áº§u káº¿t ná»‘i máº¡ng Zigbee.
  - **ÄÃ£ káº¿t ná»‘i máº¡ng, cáº§n reset:** Nháº¥n **2 láº§n liÃªn tiáº¿p (double press)** rá»“i **nháº¥n giá»¯ hÆ¡n 8 giÃ¢y** nÃºt tÆ°Æ¡ng á»©ng Ä‘á»ƒ **reset thiáº¿t bá»‹ vÃ  káº¿t ná»‘i láº¡i máº¡ng.**

### ğŸš¨ Tráº¡ng thÃ¡i Ä‘Ã¨n LED
| ÄÃ¨n bÃ¡o                      | Tráº¡ng thÃ¡i thiáº¿t bá»‹                   |
|------------------------------|---------------------------------------|
| ÄÃ¨n xanh sÃ¡ng / táº¯t          | Báº­t / táº¯t bÆ¡m nÆ°á»›c                    |
| ÄÃ¨n xanh nháº¥p nhÃ¡y liÃªn tá»¥c  | Äang káº¿t ná»‘i máº¡ng                     |
| ÄÃ¨n Ä‘á» nháº¥p nhÃ¡y ngáº¯t quÃ£ng  | Thiáº¿t bá»‹ khÃ´ng Ä‘Æ°á»£c káº¿t ná»‘i máº¡ng      |
| ÄÃ¨n Ä‘á» nháº¥p nhÃ¡y liÃªn tá»¥c    | BÃ¡o Ä‘á»™ng quÃ¡ nhiá»‡t                    |
| ÄÃ¨n cam nháº¥p nhÃ¡y liÃªn tá»¥c   | BÃ¡o Ä‘á»™ng quÃ¡ táº£i                      |

## ğŸ¤ ÄÃ³ng gÃ³p
ChÃºng tÃ´i hoan nghÃªnh má»i Ä‘Ã³ng gÃ³p! Vui lÃ²ng gá»­i Pull Request náº¿u báº¡n muá»‘n Ä‘Ã³ng gÃ³p cho dá»± Ã¡n.

## ğŸ“„ Giáº¥y phÃ©p
Dá»± Ã¡n nÃ y Ä‘Æ°á»£c cáº¥p phÃ©p theo Giáº¥y phÃ©p MIT â€“ xem tá»‡p [LICENSE](LICENSE) Ä‘á»ƒ biáº¿t thÃªm chi tiáº¿t.

## ğŸ“ Contact
Le Phuoc Thanh - lpthanh2@gmail.com

Project Link: [https://github.com/Leza1/WPCZ1](https://github.com/Leza1/WPCZ1)